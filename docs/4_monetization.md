# Метрики монетизации pt.1 {#c4_monetization}

## Запись занятия {-}

<iframe width="560" height="315" src="https://www.youtube.com/embed/bGOH02G6FHA?si=p3RrHpRkInx0-0ZQ" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>


## Разбор домашнего задания

### level 2 (HNTR)
Постройте график ретеншена для когорты пользователей, пришедшей в июне, с разбивкой по источникам привлечения (media_source). Для этого вам потребуются следующие датасеты:

- Инсталлы: https://gitlab.com/hse_mar/mar211f/-/raw/main/data/installs.csv
- Логины: https://gitlab.com/hse_mar/mar211f/-/raw/main/data/dau.csv


```r
library(data.table)
library(plotly)

installs <- fread('https://gitlab.com/hse_mar/mar211f/-/raw/main/data/installs.csv')
dau <- fread('https://gitlab.com/hse_mar/mar211f/-/raw/main/data/dau.csv')

# присоединяем источники трафика
retention <- merge(
  installs[dt < '2022-07-01', list(user_pseudo_id, dt, media_source)],
  dau[, list(user_pseudo_id, login_dt)],
  by = 'user_pseudo_id', all.x = TRUE
)

# перекодируем
retention[, uniqueN(user_pseudo_id), by = media_source]
```

```
##         media_source    V1
## 1:      applovin_int 36714
## 2:              <NA> 36169
## 3:             other  6869
## 4:      unityads_int 21932
## 5: googleadwords_int  7767
## 6:      Facebook Ads  1297
## 7:           organic    32
```

```r
retention[is.na(media_source), media_source := 'organic']
retention[media_source == 'other', media_source := 'organic']


# вычисляем лайфтайм
retention[, lifetime := login_dt - dt]

# убираем реинсталлы и ограничиваем на минимальное общее окно
retention <- retention[!user_pseudo_id %in% retention[lifetime < 0, unique(user_pseudo_id)]]
retention <- retention[lifetime <= 30]

# читаем количество вернувшихся пользователей
retention_stat <- retention[, list(returned = uniqueN(user_pseudo_id)),
                            keyby = list(media_source, lifetime)]

# считаем всего пользователей
retention_stat[, total_users := returned[lifetime == 0], by = media_source]

# альтернативный вариант
# retention_stat <- merge(
#   retention_stat,
#   retention_stat[lifetime == 0, list(media_source, total_users_2 = returned)],
#   by = 'media_source', all.x = TRUE
# )

# считаем ретеншен
retention_stat[, ret := returned / total_users]

plot_ly(retention_stat, x = ~lifetime, y = ~ret, color = ~media_source,
        type = 'scatter', mode = 'lines') %>%
  layout(
    title = 'Ретеншен по источникам пользователей',
    yaxis = list(rangemode = 'tozero')
  ) %>%
  config(displayModeBar = FALSE)
```

```{=html}
<div class="plotly html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-d4f6cbff2ed6431cdceb" style="width:672px;height:480px;"></div>
<script type="application/json" data-for="htmlwidget-d4f6cbff2ed6431cdceb">{"x":{"visdat":{"34d3b60f660c5":["function () ","plotlyVisDat"]},"cur_data":"34d3b60f660c5","attrs":{"34d3b60f660c5":{"x":{},"y":{},"mode":"lines","color":{},"alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"type":"scatter"}},"layout":{"margin":{"b":40,"l":60,"t":25,"r":10},"title":"Ретеншен по источникам пользователей","yaxis":{"domain":[0,1],"automargin":true,"rangemode":"tozero","title":"ret"},"xaxis":{"domain":[0,1],"automargin":true,"title":"lifetime"},"hovermode":"closest","showlegend":true},"source":"A","config":{"modeBarButtonsToAdd":["hoverclosest","hovercompare"],"showSendToCloud":false,"displayModeBar":false},"data":[{"x":[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30],"y":[1,0.43022359290670781,0.3084040092521203,0.23824209714726291,0.19892058596761758,0.17116422513492677,0.16576715497301464,0.15034695451040864,0.12259059367771781,0.10717039321511179,0.10562837316885119,0.090979182729375482,0.077872012336160368,0.085582112567463384,0.075558982266769464,0.07632999228989977,0.067848882035466462,0.064764841942945253,0.059367771781033155,0.060138781804163453,0.048573631457208943,0.047802621434078645,0.048573631457208943,0.043176561295296838,0.042405551272166539,0.040092521202775636,0.043176561295296838,0.037008481110254433,0.036237471087124135,0.036237471087124135,0.032382420971472627],"mode":"lines","type":"scatter","name":"Facebook Ads","marker":{"color":"rgba(252,141,98,1)","line":{"color":"rgba(252,141,98,1)"}},"textfont":{"color":"rgba(252,141,98,1)"},"error_y":{"color":"rgba(252,141,98,1)"},"error_x":{"color":"rgba(252,141,98,1)"},"line":{"color":"rgba(252,141,98,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30],"y":[1,0.36210249527513766,0.25897723848913967,0.21019474650086281,0.18047604700210906,0.16048097729327016,0.14878523103892191,0.13593908351365416,0.12284642143033225,0.11599879481771617,0.10559040236653976,0.098386699170067649,0.093648141554137337,0.090087375715576984,0.086636171902818485,0.080993727574022845,0.077186447177408316,0.073324385767892852,0.069243200306773667,0.067298474348790716,0.064805938261798465,0.064559423703744276,0.060587800268426965,0.056397052781505932,0.055301432523487362,0.053384097071954857,0.052726724917143718,0.051192856555917716,0.051028513517214935,0.046618641978690187,0.045824317291626719],"mode":"lines","type":"scatter","name":"applovin_int","marker":{"color":"rgba(102,194,165,1)","line":{"color":"rgba(102,194,165,1)"}},"textfont":{"color":"rgba(102,194,165,1)"},"error_y":{"color":"rgba(102,194,165,1)"},"error_x":{"color":"rgba(102,194,165,1)"},"line":{"color":"rgba(102,194,165,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30],"y":[1,0.39481151195784353,0.2844210241859208,0.2278070531009323,0.19821645723550871,0.1767328739359546,0.15781651128225915,0.14754762869882448,0.13106336981488989,0.12403729225780299,0.11701121470071613,0.10674233211728144,0.10147277394946629,0.097013917038238071,0.09431157951628158,0.086204566950412106,0.082556411295770848,0.085123631941629516,0.077692203756249162,0.076746385623564381,0.073368463721118771,0.071882178084042694,0.069990541818673147,0.063775165518173221,0.064720983650857988,0.061478178624510202,0.058370490474260232,0.058370490474260232,0.057289555465477641,0.056208620456695044,0.056749087961086339],"mode":"lines","type":"scatter","name":"googleadwords_int","marker":{"color":"rgba(141,160,203,1)","line":{"color":"rgba(141,160,203,1)"}},"textfont":{"color":"rgba(141,160,203,1)"},"error_y":{"color":"rgba(141,160,203,1)"},"error_x":{"color":"rgba(141,160,203,1)"},"line":{"color":"rgba(141,160,203,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30],"y":[1,0.31669888546812724,0.22868189303357916,0.1891362974630677,0.16574783418056849,0.15021121214290828,0.13932841698288823,0.1301639579007661,0.11954368630820267,0.11224075797713659,0.1045798429631751,0.099544163623779866,0.094699410515262164,0.090857020118851578,0.088923892031216437,0.084079138922698748,0.080236748526288149,0.078184291544354551,0.076513687024176033,0.072384907281449126,0.072098517935132819,0.06964034271258443,0.066060475883630468,0.064700126488627954,0.062170353929500488,0.061096393880814302,0.058137037302212355,0.058208634638791439,0.058327963533089902,0.055559533185365502,0.053936660222906371],"mode":"lines","type":"scatter","name":"organic","marker":{"color":"rgba(231,138,195,1)","line":{"color":"rgba(231,138,195,1)"}},"textfont":{"color":"rgba(231,138,195,1)"},"error_y":{"color":"rgba(231,138,195,1)"},"error_x":{"color":"rgba(231,138,195,1)"},"line":{"color":"rgba(231,138,195,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30],"y":[1,0.36588928150765604,0.23952885747938751,0.18318021201413429,0.15533568904593639,0.1339929328621908,0.12240282685512367,0.11170789163722025,0.10110718492343934,0.090459363957597169,0.084146054181389873,0.078115429917550064,0.073828032979976449,0.068928150765606599,0.065724381625441697,0.060683156654888104,0.057008244994110717,0.052014134275618372,0.050459363957597175,0.047114252061248529,0.048527679623085983,0.046219081272084808,0.043109540636042401,0.041224970553592463,0.040518256772673733,0.038586572438162547,0.038445229681978797,0.035335689045936397,0.036089517078916375,0.03477031802120141,0.033309776207302709],"mode":"lines","type":"scatter","name":"unityads_int","marker":{"color":"rgba(166,216,84,1)","line":{"color":"rgba(166,216,84,1)"}},"textfont":{"color":"rgba(166,216,84,1)"},"error_y":{"color":"rgba(166,216,84,1)"},"error_x":{"color":"rgba(166,216,84,1)"},"line":{"color":"rgba(166,216,84,1)"},"xaxis":"x","yaxis":"y","frame":null}],"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.20000000000000001,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>
```

### level 3 (HMP)
Постройте линейный график retention 1 day (ret1) для всех дневных когорт.
Т.е. по оси OX должна быть дата инсталла, по оси OY -- значение ретеншена первого для пользователей, пришедших в этот день.

### level 4 (UV)
Добавьте на этот график группировку по источникам трафика (media_source).


```r
# пересобираем датасет
retention_daily <- merge(
  installs[, list(user_pseudo_id, dt, media_source)],
  dau[, list(user_pseudo_id, login_dt)],
  by = 'user_pseudo_id', all.x = TRUE
)

retention_daily[is.na(media_source), media_source := 'organic']
retention_daily[media_source == 'other', media_source := 'organic']

retention_daily[, uniqueN(user_pseudo_id), by = media_source]
```

```
##         media_source    V1
## 1:      applovin_int 36818
## 2:           organic 57690
## 3:      unityads_int 22017
## 4: googleadwords_int  7774
## 5:      Facebook Ads  1297
```

```r
retention_daily[, lifetime := login_dt - dt]
retention_daily <- retention_daily[!user_pseudo_id %in% retention_daily[lifetime < 0, unique(user_pseudo_id)]]

# считаем по дням инсталла вернувшихся на lifetime == 0
retention_daily_stat <- merge(
  retention_daily[lifetime == 0, list(total_users = uniqueN(user_pseudo_id)), by = list(dt, media_source)],
  retention_daily[lifetime == 1, list(returned_d1 = uniqueN(user_pseudo_id)), by = list(dt, media_source)],
  by = c('dt', 'media_source'), all.x = TRUE
)

# считаем ретеншен
retention_daily_stat[, ret1 := returned_d1 / total_users]
retention_daily_stat <- retention_daily_stat[order(dt)]
setkey(retention_daily_stat, dt)


plot_ly(retention_daily_stat, x = ~dt, y = ~ret1, color = ~media_source,
        type = 'scatter', mode = 'lines') %>%
  layout(
    title = 'Динамика retention 1 day по дням',
    yaxis = list(rangemode = 'tozero')
  ) %>%
  config(displayModeBar = FALSE)
```

```{=html}
<div class="plotly html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-24e53019c60752ef19b4" style="width:672px;height:480px;"></div>
<script type="application/json" data-for="htmlwidget-24e53019c60752ef19b4">{"x":{"visdat":{"34d3b69bd90":["function () ","plotlyVisDat"]},"cur_data":"34d3b69bd90","attrs":{"34d3b69bd90":{"x":{},"y":{},"mode":"lines","color":{},"alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"type":"scatter"}},"layout":{"margin":{"b":40,"l":60,"t":25,"r":10},"title":"Динамика retention 1 day по дням","yaxis":{"domain":[0,1],"automargin":true,"rangemode":"tozero","title":"ret1"},"xaxis":{"domain":[0,1],"automargin":true,"title":"dt"},"hovermode":"closest","showlegend":true},"source":"A","config":{"modeBarButtonsToAdd":["hoverclosest","hovercompare"],"showSendToCloud":false,"displayModeBar":false},"data":[{"x":["2022-06-01","2022-06-02","2022-06-03","2022-06-04","2022-06-05","2022-06-06","2022-06-07","2022-06-08","2022-06-09","2022-06-10","2022-06-11","2022-06-12","2022-06-13","2022-06-14","2022-06-15","2022-06-16","2022-06-17","2022-06-18","2022-06-19","2022-06-20","2022-06-21",null,"2022-06-23"],"y":[0.34482758620689657,0.4838709677419355,0.38554216867469882,0.42391304347826086,0.53409090909090906,0.41095890410958902,0.43661971830985913,0.44776119402985076,0.47058823529411764,0.34090909090909088,0.44444444444444442,0.3392857142857143,0.37931034482758619,0.31818181818181818,0.47457627118644069,0.5357142857142857,0.5178571428571429,0.33823529411764708,0.51111111111111107,0.33333333333333331,0.5,null,1],"mode":"lines","type":"scatter","name":"Facebook Ads","marker":{"color":"rgba(252,141,98,1)","line":{"color":"rgba(252,141,98,1)"}},"textfont":{"color":"rgba(252,141,98,1)"},"error_y":{"color":"rgba(252,141,98,1)"},"error_x":{"color":"rgba(252,141,98,1)"},"line":{"color":"rgba(252,141,98,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":["2022-06-01","2022-06-02","2022-06-03","2022-06-04","2022-06-05","2022-06-06","2022-06-07","2022-06-08","2022-06-09","2022-06-10","2022-06-11","2022-06-12","2022-06-13","2022-06-14","2022-06-15","2022-06-16","2022-06-17","2022-06-18","2022-06-19","2022-06-20","2022-06-21","2022-06-22","2022-06-23","2022-06-24","2022-06-26","2022-06-27","2022-06-28","2022-06-29","2022-06-30",null,"2022-07-05","2022-07-08","2022-07-11","2022-07-12","2022-07-13","2022-07-14",null,"2022-07-21",null,"2022-07-24","2022-07-28","2022-07-29"],"y":[0.42120622568093385,0.37134778510838834,0.42228739002932553,0.39526791927627003,0.40045506257110353,0.38530219780219782,0.38795180722891565,0.34130146082337315,0.36412213740458016,0.35828877005347592,0.35862995298858297,0.35570890840652447,0.35714285714285715,0.35182250396196513,0.3558421851289833,0.33873456790123457,0.34556574923547401,0.36183689627870153,0.33049738219895286,0.34125344352617082,0.36127450980392156,0.37245392822502427,0.3330029732408325,0.31678832116788319,0.34042553191489361,0.26666666666666666,0.26666666666666666,0.29999999999999999,0.20000000000000001,null,0.5,1,0.33333333333333331,1,0.5,1,null,0.5,null,1,1,1],"mode":"lines","type":"scatter","name":"applovin_int","marker":{"color":"rgba(102,194,165,1)","line":{"color":"rgba(102,194,165,1)"}},"textfont":{"color":"rgba(102,194,165,1)"},"error_y":{"color":"rgba(102,194,165,1)"},"error_x":{"color":"rgba(102,194,165,1)"},"line":{"color":"rgba(102,194,165,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":["2022-06-01","2022-06-02","2022-06-03","2022-06-04","2022-06-05","2022-06-06","2022-06-07","2022-06-08","2022-06-09","2022-06-10","2022-06-11","2022-06-12","2022-06-13","2022-06-14","2022-06-15","2022-06-16","2022-06-17","2022-06-18","2022-06-19","2022-06-20","2022-06-21","2022-06-22","2022-06-23","2022-06-24","2022-06-26","2022-06-27","2022-06-28","2022-06-29","2022-06-30"],"y":[0.36734693877551022,0.42758620689655175,0.40140845070422537,0.35874439461883406,0.44537815126050423,0.37551020408163266,0.40756302521008403,0.38983050847457629,0.41762452107279696,0.35514018691588783,0.35197368421052633,0.43768996960486323,0.40357142857142858,0.40284360189573459,0.31868131868131866,0.3350253807106599,0.35048231511254019,0.36227544910179643,0.33458646616541354,0.38566552901023893,0.39556962025316456,0.36479591836734693,0.39018691588785048,0.40712468193384221,0.35253456221198154,0.29017857142857145,0.25,0.25,0.14285714285714285],"mode":"lines","type":"scatter","name":"googleadwords_int","marker":{"color":"rgba(141,160,203,1)","line":{"color":"rgba(141,160,203,1)"}},"textfont":{"color":"rgba(141,160,203,1)"},"error_y":{"color":"rgba(141,160,203,1)"},"error_x":{"color":"rgba(141,160,203,1)"},"line":{"color":"rgba(141,160,203,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":["2022-06-01","2022-06-02","2022-06-03","2022-06-04","2022-06-05","2022-06-06","2022-06-07","2022-06-08","2022-06-09","2022-06-10","2022-06-11","2022-06-12","2022-06-13","2022-06-14","2022-06-15","2022-06-16","2022-06-17","2022-06-18","2022-06-19","2022-06-20","2022-06-21","2022-06-22","2022-06-23","2022-06-24","2022-06-26","2022-06-27","2022-06-28","2022-06-29","2022-06-30","2022-07-01","2022-07-02","2022-07-03","2022-07-04","2022-07-05","2022-07-07","2022-07-08","2022-07-09","2022-07-10","2022-07-11","2022-07-12","2022-07-13","2022-07-14","2022-07-15","2022-07-16","2022-07-17","2022-07-18","2022-07-19","2022-07-21","2022-07-22","2022-07-23","2022-07-24","2022-07-25","2022-07-26","2022-07-27","2022-07-28","2022-07-29","2022-07-30"],"y":[0.30182926829268292,0.31735015772870662,0.32426920462270564,0.32886297376093293,0.30798071772897695,0.32265579499126384,0.3573859768550034,0.34330985915492956,0.32193548387096776,0.31487889273356401,0.31812339331619538,0.31587473002159827,0.34787735849056606,0.32614056720098644,0.34588235294117647,0.28008998875140606,0.26806083650190116,0.26525821596244131,0.27578834847675038,0.28798185941043086,0.26953981008035061,0.30471698113207546,0.29933899905571293,0.27340425531914891,0.27618069815195073,0.29411764705882354,0.33881163084702909,0.30220492866407261,0.305111821086262,0.30868761552680224,0.32781456953642385,0.34328358208955223,0.35738255033557048,0.3155737704918033,0.35129740518962077,0.35249042145593867,0.40733944954128443,0.35384615384615387,0.31760435571687839,0.3075356415478615,0.34482758620689657,0.35881104033970274,0.32994923857868019,0.31850117096018737,0.32107843137254904,0.41277641277641275,0.33564814814814814,0.36979166666666669,0.34894613583138173,0.36778846153846156,0.35844748858447489,0.37336814621409919,0.38944723618090454,0.38440860215053763,0.3553530751708428,0.35537190082644626,0.36344086021505378],"mode":"lines","type":"scatter","name":"organic","marker":{"color":"rgba(231,138,195,1)","line":{"color":"rgba(231,138,195,1)"}},"textfont":{"color":"rgba(231,138,195,1)"},"error_y":{"color":"rgba(231,138,195,1)"},"error_x":{"color":"rgba(231,138,195,1)"},"line":{"color":"rgba(231,138,195,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":["2022-06-01","2022-06-02","2022-06-03","2022-06-04","2022-06-05","2022-06-06","2022-06-07","2022-06-08","2022-06-09","2022-06-10","2022-06-11","2022-06-12","2022-06-13","2022-06-14","2022-06-15","2022-06-16","2022-06-17","2022-06-18","2022-06-19","2022-06-20","2022-06-21","2022-06-22","2022-06-23","2022-06-24","2022-06-26","2022-06-27","2022-06-28","2022-06-29","2022-06-30","2022-07-01","2022-07-02","2022-07-03",null,"2022-07-15",null,"2022-07-25"],"y":[0.35907590759075908,0.40875232774674114,0.4110344827586207,0.39911797133406834,0.39227642276422764,0.37699316628701596,0.39776951672862454,0.40166865315852207,0.38860103626943004,0.40917431192660553,0.36228287841191065,0.32869080779944287,0.38450502152080346,0.34538878842676313,0.37104072398190047,0.36393442622950822,0.34120734908136485,0.33333333333333331,0.28229166666666666,0.30451127819548873,0.28315412186379929,0.35148514851485146,0.27492447129909364,0.37772397094430993,0.32738853503184712,0.30687203791469192,0.30814814814814817,0.33029197080291972,0.28378378378378377,0.22222222222222221,0.33333333333333331,0.10000000000000001,null,0.5,null,1],"mode":"lines","type":"scatter","name":"unityads_int","marker":{"color":"rgba(166,216,84,1)","line":{"color":"rgba(166,216,84,1)"}},"textfont":{"color":"rgba(166,216,84,1)"},"error_y":{"color":"rgba(166,216,84,1)"},"error_x":{"color":"rgba(166,216,84,1)"},"line":{"color":"rgba(166,216,84,1)"},"xaxis":"x","yaxis":"y","frame":null}],"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.20000000000000001,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>
```

### level 5 (N)

Постройте и сравните графики rolling retention и retention rate (возьмите данные за логины и инсталлы из практикума).


```r
# считаем rolling retention
# сначала вычисляем максимальную дату захода по каждому пользователю
rret <- retention[, list(lifetime = max(lifetime)), by = user_pseudo_id]

# считаем количество дней от инсталла до последнего логина
rret_stat <- rret[, list(rret_users = uniqueN(user_pseudo_id)), by = lifetime]

# нужна обратная кумулята, так как мы считаем "сколько вернулось после дня x"
# а в статистике у нас "для какого количества пользователей это был последний день" - то есть, для каждого дня надо получить,
# накопительную сумму этого и всех следующих дней. а это делается с помощью обратной кумуляты
# для этого мы переворачиваем значения колонки с помощью rev(), считаем обычную кумуляту
# а потом результат переворачиваем обратно
# чтобы понять результат, попробуйте выражения: 1:5; rev(1:5), cumsum(1:5), cumsum(rev(1:5)), rev(cumsum(rev(1:5)))
setkey(rret_stat, lifetime)
rret_stat[, rret_users_cum := cumsum(rret_users)]
rret_stat[, rret_users_cum_rev := cumsum(rev(rret_users))]
rret_stat[, rret_users_cum_rev_rev := rev(cumsum(rev(rret_users)))]

rret_stat[, rolling_ret := rret_users_cum_rev_rev / rret_users_cum_rev_rev[lifetime == 0]]
```



```r
# считаем простой retention без разбивки по платформам или источникам привлечения
retention_stat <- retention[, list(returned = uniqueN(user_pseudo_id)),
                            keyby = list(lifetime)]

retention_stat[, total_users := returned[lifetime == 0]]

retention_stat[, ret := returned / total_users]
```



```r
# собираем обе таблицы ретеншена и рисуем
plot_ly(rret_stat, x = ~lifetime, y = ~rolling_ret,
        type = 'scatter', mode = 'lines', name = 'rolling ret') %>%
  add_trace(data = retention_stat, y = ~ret, name = 'retention rate') %>%
  layout(
    title = 'Rolling retention VS Retention rate',
    yaxis = list(rangemode = 'tozero')
  )
```

```{=html}
<div class="plotly html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-255115f6e6b8f4be1b58" style="width:672px;height:480px;"></div>
<script type="application/json" data-for="htmlwidget-255115f6e6b8f4be1b58">{"x":{"visdat":{"34d3b798c4101":["function () ","plotlyVisDat"],"34d3b2b3f61fc":["function () ","data"]},"cur_data":"34d3b2b3f61fc","attrs":{"34d3b798c4101":{"x":{},"y":{},"mode":"lines","name":"rolling ret","alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"type":"scatter"},"34d3b2b3f61fc":{"x":{},"y":{},"mode":"lines","name":"retention rate","alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"type":"scatter","inherit":true}},"layout":{"margin":{"b":40,"l":60,"t":25,"r":10},"title":"Rolling retention VS Retention rate","yaxis":{"domain":[0,1],"automargin":true,"rangemode":"tozero","title":"rolling_ret"},"xaxis":{"domain":[0,1],"automargin":true,"title":"lifetime"},"hovermode":"closest","showlegend":true},"source":"A","config":{"modeBarButtonsToAdd":["hoverclosest","hovercompare"],"showSendToCloud":false},"data":[{"x":[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30],"y":[1,0.48447392497712716,0.39131747483989021,0.34311985361390668,0.30999085086916744,0.28483989021042999,0.26383348581884719,0.24462031107044832,0.22789569990850869,0.21390667886550777,0.20177493138151875,0.19086001829826166,0.18098810612991767,0.17167429094236047,0.16273559011893871,0.15425434583714548,0.14634034766697163,0.13922232387923147,0.13213174748398901,0.12572735590118939,0.11953339432753889,0.1128636779505947,0.10634034766697163,0.10021043000914913,0.094656907593778594,0.088664226898444651,0.082387923147301007,0.075754803293687098,0.068783165599268073,0.059295516925892043,0.046678865507776758],"mode":"lines","name":"rolling ret","type":"scatter","marker":{"color":"rgba(31,119,180,1)","line":{"color":"rgba(31,119,180,1)"}},"error_y":{"color":"rgba(31,119,180,1)"},"error_x":{"color":"rgba(31,119,180,1)"},"line":{"color":"rgba(31,119,180,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30],"y":[1,0.34833337948732152,0.24577921778220857,0.19829599475690696,0.17128668088209503,0.15255739248428457,0.14077889470429139,0.12992347668762058,0.1178680549786307,0.10998495379985784,0.10177877470392216,0.095344908753565397,0.090517201591389512,0.086658728180702096,0.083815642509669261,0.07850793387056576,0.074667922055144789,0.071732528407779717,0.068834057950947547,0.065870971910682807,0.064827891778128546,0.063230963787580891,0.059778645472755298,0.056981713789888581,0.055550940156738941,0.053861704189859048,0.052292468592211053,0.051120157292791672,0.051175542078591013,0.048286302419392059,0.047095529524706227],"mode":"lines","name":"retention rate","type":"scatter","marker":{"color":"rgba(255,127,14,1)","line":{"color":"rgba(255,127,14,1)"}},"error_y":{"color":"rgba(255,127,14,1)"},"error_x":{"color":"rgba(255,127,14,1)"},"line":{"color":"rgba(255,127,14,1)"},"xaxis":"x","yaxis":"y","frame":null}],"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.20000000000000001,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>
```


## Платежные метрики

### Gross / Net {-}

Gross - общая сумма всех платежей

Revenue (или Net) - сумма платежей после вычета налогов и комиссии магазина приложений. 

#### задача 1

Нарисовать график суммы платежей по дням, с разбивкой по группам лайфтайма пользователей.


```r
# импортируем даатсает
payments <- fread('https://gitlab.com/hse_mar/mar211f/-/raw/main/data/payments_custom.csv') 

# считаем количество дней от инсталла
payments[, lifetime := pay_dt - install_dt]

# делим на группы
payments[, lifetime_group := cut(lifetime, 
                            breaks = c(-Inf, -1, 0, 7, 28, Inf), 
                            ordered_result = TRUE)]

# считаем гросс
payments_stat <- payments[, list(gross = sum(gross)), 
                          keyby = list(pay_dt, lifetime_group)]

payments_stat[, total_gross := sum(gross), by = pay_dt]
payments_stat[, share := gross / total_gross]


# area-plot
plot_ly(payments_stat, x = ~pay_dt, y = ~gross, color = ~lifetime_group,
        type = 'scatter', mode = 'none', stackgroup = 'one') %>%
  layout(
    title = 'Gross по группам пользователей',
    xaxis = list(title = ''),
    yaxis = list(title = '', rangemode = 'tozero')) %>%  
  config(displayModeBar = FALSE)
```

```{=html}
<div class="plotly html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-0ead640dd3cbca55d177" style="width:672px;height:480px;"></div>
<script type="application/json" data-for="htmlwidget-0ead640dd3cbca55d177">{"x":{"visdat":{"34d3b6a4faf77":["function () ","plotlyVisDat"]},"cur_data":"34d3b6a4faf77","attrs":{"34d3b6a4faf77":{"x":{},"y":{},"mode":"none","stackgroup":"one","color":{},"alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"type":"scatter"}},"layout":{"margin":{"b":40,"l":60,"t":25,"r":10},"title":"Gross по группам пользователей","xaxis":{"domain":[0,1],"automargin":true,"title":""},"yaxis":{"domain":[0,1],"automargin":true,"title":"","rangemode":"tozero"},"hovermode":"closest","showlegend":true},"source":"A","config":{"modeBarButtonsToAdd":["hoverclosest","hovercompare"],"showSendToCloud":false,"displayModeBar":false},"data":[{"x":["2022-06-01","2022-06-02","2022-06-03","2022-06-04","2022-06-05","2022-06-06","2022-06-07","2022-06-08","2022-06-09","2022-06-10","2022-06-11","2022-06-12","2022-06-13","2022-06-14","2022-06-15","2022-06-16","2022-06-17","2022-06-18","2022-06-19","2022-06-20","2022-06-21","2022-06-22","2022-06-23","2022-06-24","2022-06-25","2022-06-26","2022-06-27","2022-06-28","2022-06-29","2022-06-30","2022-07-01","2022-07-02","2022-07-03","2022-07-04","2022-07-05","2022-07-06","2022-07-07","2022-07-08","2022-07-09","2022-07-10","2022-07-11","2022-07-12","2022-07-13","2022-07-14","2022-07-15","2022-07-16","2022-07-17","2022-07-18","2022-07-19","2022-07-20","2022-07-21","2022-07-22","2022-07-23","2022-07-24","2022-07-25","2022-07-26","2022-07-27","2022-07-28","2022-07-29","2022-07-30","2022-07-31"],"y":[3338.5299999999775,2600.2599999999925,1925.580000000002,1923.4800000000018,1874.4300000000019,2105.4900000000016,2987.6499999999769,3311.5099999999647,2653.9899999999884,2417.1699999999937,2643.3599999999897,2853.0199999999923,2002.6700000000021,1846.3700000000017,1584.4700000000016,3871.4299999999694,2299.6199999999985,1857.8600000000019,1982.7600000000018,1822.3700000000015,1683.7800000000018,1746.7700000000016,1883.8000000000018,1823.600000000002,1546.1200000000017,1916.7800000000018,1654.0400000000016,2019.510000000002,1549.7900000000018,1403.5600000000015,4378.1499999999587,4410.7699999999531,3960.2599999999584,3541.8599999999819,2917.8599999999901,3155.0299999999793,2664.9699999999925,2571.679999999993,3925.6899999999605,2930.329999999984,2720.3199999999924,2536.9199999999942,2400.999999999995,3444.4199999999596,2101.8500000000017,5244.649999999936,3493.0099999999675,2883.6699999999882,2619.0199999999932,2706.8599999999915,2861.6899999999891,2788.5999999999904,3065.9299999999862,2523.5599999999927,2633.5999999999899,2312.0599999999968,2649.059999999994,2206.1599999999989,2459.8999999999937,2649.8599999999919,3620.0199999999704],"mode":"none","stackgroup":"one","type":"scatter","name":"(28, Inf]","marker":{"color":"rgba(253,231,37,1)","line":{"color":"rgba(253,231,37,1)"}},"textfont":{"color":"rgba(253,231,37,1)"},"error_y":{"color":"rgba(253,231,37,1)"},"error_x":{"color":"rgba(253,231,37,1)"},"line":{"color":"rgba(253,231,37,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":["2022-06-01","2022-06-02","2022-06-03","2022-06-04","2022-06-05","2022-06-06","2022-06-07","2022-06-08","2022-06-09","2022-06-10","2022-06-11","2022-06-12","2022-06-13","2022-06-14","2022-06-15","2022-06-16","2022-06-17","2022-06-18","2022-06-19","2022-06-20","2022-06-21","2022-06-22","2022-06-23","2022-06-24","2022-06-25","2022-06-26","2022-06-27","2022-06-28","2022-06-29","2022-06-30","2022-07-01","2022-07-02","2022-07-03","2022-07-04","2022-07-05","2022-07-06","2022-07-07","2022-07-08","2022-07-09","2022-07-10","2022-07-11","2022-07-12","2022-07-13","2022-07-14","2022-07-15","2022-07-16","2022-07-17","2022-07-18","2022-07-19","2022-07-20","2022-07-21","2022-07-22","2022-07-23","2022-07-24","2022-07-25","2022-07-26","2022-07-27","2022-07-28","2022-07-29","2022-07-30","2022-07-31"],"y":[1648.3500000000013,1040.7300000000009,1181.8600000000008,995.60000000000105,1248.6100000000008,1239.7200000000009,1437.4900000000016,1830.0200000000018,1316.7300000000012,1273.5800000000011,1561.2900000000016,1481.5100000000014,1500.4800000000014,1390.7700000000011,1776.7500000000014,2111.7800000000011,1783.0600000000015,1542.2300000000014,1626.2900000000013,1320.6400000000012,1633.2400000000014,1783.0900000000015,1328.7800000000011,1654.2600000000014,1569.1700000000014,1603.2200000000014,1301.7200000000012,1401.6300000000012,1299.5200000000013,1445.650000000001,2476.7999999999938,1996.0800000000017,2016.7300000000018,1433.640000000001,1100.640000000001,1249.620000000001,1360.700000000001,1359.600000000001,1057.8000000000009,915.90000000000066,853.05000000000075,568.43000000000018,698.24000000000035,836.11000000000047,717.5900000000006,1001.0200000000007,948.12000000000057,378.50000000000017,428.34000000000032,352.64000000000004,337.68000000000001,364.65000000000003,381.79000000000002,233.77999999999997,213.82999999999998,234.81,342.73000000000008,349.75000000000011,205.84999999999991,132.73999999999998,276.85000000000008],"mode":"none","stackgroup":"one","type":"scatter","name":"(7,28]","marker":{"color":"rgba(93,200,99,1)","line":{"color":"rgba(93,200,99,1)"}},"textfont":{"color":"rgba(93,200,99,1)"},"error_y":{"color":"rgba(93,200,99,1)"},"error_x":{"color":"rgba(93,200,99,1)"},"line":{"color":"rgba(93,200,99,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":["2022-06-01","2022-06-02","2022-06-03","2022-06-04","2022-06-05","2022-06-06","2022-06-07","2022-06-08","2022-06-09","2022-06-10","2022-06-11","2022-06-12","2022-06-13","2022-06-14","2022-06-15","2022-06-16","2022-06-17","2022-06-18","2022-06-19","2022-06-20","2022-06-21","2022-06-22","2022-06-23","2022-06-24","2022-06-25","2022-06-26","2022-06-27","2022-06-28","2022-06-29","2022-06-30","2022-07-01","2022-07-02","2022-07-03","2022-07-04","2022-07-05","2022-07-06","2022-07-07","2022-07-08","2022-07-09","2022-07-10","2022-07-11","2022-07-12","2022-07-13","2022-07-14","2022-07-15","2022-07-16","2022-07-17","2022-07-18","2022-07-19","2022-07-20","2022-07-21","2022-07-22","2022-07-23","2022-07-24","2022-07-25","2022-07-26","2022-07-27","2022-07-28","2022-07-29","2022-07-30","2022-07-31"],"y":[1155.4300000000012,867.69000000000096,1102.420000000001,1152.5100000000011,2160.8800000000001,2014.0100000000016,1395.6200000000013,1556.2600000000016,1306.7000000000012,1238.3700000000013,1473.1900000000014,906.86000000000092,1271.5900000000013,1197.610000000001,1198.5700000000013,1498.3800000000012,1462.5400000000013,1181.8200000000011,1090.5900000000008,1052.8100000000009,765.01000000000056,702.30000000000041,892.78000000000077,665.18000000000063,983.8900000000009,524.45000000000039,620.36000000000047,702.16000000000054,432.57000000000016,320.55000000000013,497.46000000000038,351.60000000000019,262.78000000000009,288.73000000000013,250.66000000000011,245.77000000000012,233.68000000000001,274.60000000000025,227.59000000000006,175.65000000000001,172.71999999999994,85.829999999999998,98.799999999999969,67.849999999999994,84.84999999999998,91.820000000000007,132.80999999999997,122.86999999999996,29.940000000000001,35.940000000000005,40.920000000000002,86.899999999999991,89.829999999999998,62.900000000000006,28.900000000000002,122.77999999999993,31.909999999999997,129.80999999999992,81.839999999999989,11.970000000000001,147.82999999999996],"mode":"none","stackgroup":"one","type":"scatter","name":"(0,7]","marker":{"color":"rgba(33,144,140,1)","line":{"color":"rgba(33,144,140,1)"}},"textfont":{"color":"rgba(33,144,140,1)"},"error_y":{"color":"rgba(33,144,140,1)"},"error_x":{"color":"rgba(33,144,140,1)"},"line":{"color":"rgba(33,144,140,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":["2022-06-01","2022-06-02","2022-06-03","2022-06-04","2022-06-05","2022-06-06","2022-06-07","2022-06-08","2022-06-09","2022-06-10","2022-06-11","2022-06-12","2022-06-13","2022-06-14","2022-06-15","2022-06-16","2022-06-17","2022-06-18","2022-06-19","2022-06-20","2022-06-21","2022-06-22","2022-06-23","2022-06-24","2022-06-25","2022-06-26","2022-06-27","2022-06-28","2022-06-29","2022-06-30","2022-07-01","2022-07-02","2022-07-03","2022-07-04","2022-07-05","2022-07-06","2022-07-07","2022-07-08","2022-07-09","2022-07-10","2022-07-11","2022-07-12","2022-07-13","2022-07-15","2022-07-16","2022-07-17","2022-07-18","2022-07-19","2022-07-20","2022-07-21","2022-07-22","2022-07-23","2022-07-24","2022-07-25","2022-07-26","2022-07-27","2022-07-28","2022-07-29","2022-07-30","2022-07-31"],"y":[432.51000000000033,693.37000000000035,468.56000000000029,618.25000000000045,786.14000000000044,496.4200000000003,364.42000000000024,481.4200000000003,233.63000000000008,209.77000000000001,334.59000000000009,358.41000000000025,326.52000000000021,411.52000000000032,142.66,827.23000000000059,203.74000000000001,428.5100000000001,430.45000000000033,420.42000000000024,255.67000000000004,419.58000000000015,354.56000000000012,114.75999999999998,118.80999999999997,104.73999999999994,69.910000000000011,95.920000000000016,31.950000000000003,65.890000000000001,28.950000000000003,6.9700000000000006,162.80000000000001,61.900000000000013,40.940000000000005,14.98,66.890000000000015,100.92999999999999,96.859999999999971,69.900000000000006,65.870000000000019,38.930000000000007,35.950000000000003,28.960000000000001,26.950000000000003,38.930000000000007,37.950000000000003,38.960000000000001,48.950000000000003,22.960000000000001,30.910000000000004,9.9900000000000002,9.9600000000000009,41.940000000000005,17.969999999999999,63.920000000000016,23.969999999999999,13.960000000000001,25.959999999999997,9.9900000000000002],"mode":"none","stackgroup":"one","type":"scatter","name":"(-1,0]","marker":{"color":"rgba(59,82,139,1)","line":{"color":"rgba(59,82,139,1)"}},"textfont":{"color":"rgba(59,82,139,1)"},"error_y":{"color":"rgba(59,82,139,1)"},"error_x":{"color":"rgba(59,82,139,1)"},"line":{"color":"rgba(59,82,139,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":["2022-06-01","2022-06-02","2022-06-03","2022-06-04","2022-06-05","2022-06-06","2022-06-07","2022-06-08","2022-06-09","2022-06-10","2022-06-11","2022-06-12","2022-06-13","2022-06-14","2022-06-15","2022-06-16","2022-06-17","2022-06-18","2022-06-19","2022-06-20","2022-06-21","2022-06-22","2022-06-23","2022-06-24","2022-06-25","2022-06-26","2022-06-27","2022-06-28","2022-06-29","2022-06-30","2022-07-01","2022-07-02","2022-07-03","2022-07-04","2022-07-05","2022-07-06","2022-07-07","2022-07-08","2022-07-09","2022-07-10","2022-07-11","2022-07-12","2022-07-13","2022-07-14","2022-07-15","2022-07-16","2022-07-17","2022-07-18","2022-07-19","2022-07-20","2022-07-21","2022-07-22","2022-07-23","2022-07-24","2022-07-25","2022-07-26","2022-07-27","2022-07-28","2022-07-29","2022-07-30","2022-07-31"],"y":[159.84,123.87999999999998,53.900000000000013,136.85999999999999,96.890000000000001,23.960000000000001,119.91999999999997,151.81999999999999,109.83999999999997,79.019999999999996,147.81999999999999,116.84999999999998,117.89999999999999,84.890000000000001,157.83000000000001,248.72000000000008,119.86999999999998,253.79000000000005,219.81000000000006,215.93000000000001,112.90000000000001,84.899999999999991,99.939999999999984,94.859999999999999,357.60000000000008,81.859999999999985,157.89000000000001,126.89,27.93,55.000000000000007,210.90000000000003,148.84999999999999,237.7300000000001,98.869999999999976,65.920000000000002,38.920000000000002,81.929999999999993,87.889999999999986,98.890000000000001,133.85999999999999,163.80000000000004,74.950000000000003,101.92,60.860000000000007,120.72999999999995,221.83999999999997,242.83000000000004,67.929999999999993,78.850000000000009,126.88999999999997,14.98,109.87999999999998,179.80000000000001,29.950000000000003,76.97999999999999,33.950000000000003,92.930000000000007,47.960000000000001,39.940000000000005,152.78999999999996,94.879999999999995],"mode":"none","stackgroup":"one","type":"scatter","name":"(-Inf,-1]","marker":{"color":"rgba(68,1,84,1)","line":{"color":"rgba(68,1,84,1)"}},"textfont":{"color":"rgba(68,1,84,1)"},"error_y":{"color":"rgba(68,1,84,1)"},"error_x":{"color":"rgba(68,1,84,1)"},"line":{"color":"rgba(68,1,84,1)"},"xaxis":"x","yaxis":"y","frame":null}],"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.20000000000000001,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>
```

<!-- ### задача 1 {-} -->
<!-- Нарисовать график суммы платежей по дням -->

<!-- ```{r, warning=FALSE, message=FALSE} -->
<!-- library(data.table) -->
<!-- library(plotly) -->
<!-- payments <- fread('https://gitlab.com/hse_mar/mar211f/-/raw/main/data/payments_custom.csv') -->
<!-- daily_gross <- payments[, list(n_payers = uniqueN(user_pseudo_id),  -->
<!--                                gross = sum(gross)), by = pay_dt] -->
<!-- daily_gross <- daily_gross[order(pay_dt)] -->

<!-- plot_ly(daily_gross, x = ~pay_dt, y = ~gross, type = 'scatter', mode = 'none', stackgroup = 'one') %>% -->
<!--   layout( -->
<!--     # title = 'Выручка в день', -->
<!--     title = 'Gross по дням' -->
<!--   ) %>% -->
<!--   config(displayModeBar = FALSE) -->

<!-- ``` -->

<!-- ### задача 2 {-} -->

<!-- Добавить на график группировку по платформам. -->

<!-- ```{r} -->
<!-- daily_gross_platform <- payments[, list(n_payers = uniqueN(user_pseudo_id),  -->
<!--                                gross = sum(gross)), by = list(platform, pay_dt)] -->
<!-- daily_gross_platform <- daily_gross_platform[order(pay_dt)] -->

<!-- # area plot -->
<!-- plot_ly(daily_gross_platform, x = ~pay_dt, y = ~gross, color = ~platform, -->
<!--         type = 'scatter', mode = 'none', stackgroup = 'one') %>% -->
<!--   layout( -->
<!--     # title = 'Выручка в день', -->
<!--     title = 'Gross по дням, группировка по платформам' -->
<!--   ) %>% -->
<!--   config(displayModeBar = FALSE) -->
<!-- ``` -->


<!-- ```{r} -->
<!-- # второй вариант, линиями -->
<!-- plot_ly(daily_gross_platform, x = ~pay_dt, y = ~gross, color = ~platform, -->
<!--         type = 'scatter', mode = 'line') %>% -->
<!--   layout( -->
<!--     # title = 'Выручка в день', -->
<!--     title = 'Gross по дням, группировка по платформам', -->
<!--     yaxis = list(rangemode = 'tozero') -->
<!--   ) %>% -->
<!--   config(displayModeBar = FALSE) -->
<!-- ``` -->

<!-- ### задача 3 {-} -->

<!-- Добавить на график группировку по offer_type  -->

<!-- ```{r} -->
<!-- daily_gross_offer <- payments[, list(n_payers = uniqueN(user_pseudo_id),  -->
<!--                                         gross = sum(gross)), by = list(offer_type, pay_dt)] -->
<!-- daily_gross_offer <- daily_gross_offer[order(offer_type, pay_dt)] -->

<!-- plot_ly(daily_gross_offer, x = ~pay_dt, y = ~gross, color = ~offer_type, -->
<!--         type = 'scatter', mode = 'none', stackgroup = 'one') %>% -->
<!--   layout( -->
<!--     # title = 'Выручка в день', -->
<!--     title = 'Gross по дням, группировка по типам платежей' -->
<!--   ) %>% -->
<!--   config(displayModeBar = FALSE) -->
<!-- ``` -->


<!-- <br> -->

### Конверсия {-}
Conversion = N Paying Users / N Users

Конверсия обычно считается в каком-то "окне", - минимальном общем количестве дней, которые могли прожить в приложении пользователи разных сегментов когорт. Например, пользователи, которые пришли месяц назад, могли платить 30 дней. Пользователи, которые пришли пять дней назад - могли платить только пять дней. Соответственно, если мы хотим сравнивать конверсию этих двух когорт, то считать надо с ограничением в пять дней - сколько пользователей первой когорты сконвертировалось за пять дней в приложении (несмотря на то, что они пришли месяц назад), и сколько пользователей второй когорты сконвертировалось за пять дней.

Аналогично, когда оцениваем конверсию месячной когорты (всех пользователей, которые, например, пришли в сентябре), то надо так же считать конверсию только за какое-то определенное количество дней, чтобы не было перекосов из-за неравномерной длительности жизни пользователей в приложении.

<br>

#### задача 2 {-}

Посчитать, какая доля пользователей, которая пришла в июне, стала платящими в интервале 30 дней от инсталла.

**Алгоритм 1 (не очень гибкий):**
 - посчитать количество платящих в payments, у которых install_dt был в июне, а lifetime (дата платежа  - дата инсталла) меньше или равен 30
 - по таблице installs посчитать, сколько всего пришло пользователей в июне
 - поделить одно на другое


```r
# импортируем инсталлы
installs <- fread('https://gitlab.com/hse_mar/mar211f/-/raw/main/data/installs.csv')

# создаем епременную лайфтайма
payments[, lifetime := as.numeric(pay_dt - install_dt)]

# выделяем сегмент пользователей
payers_june <- payments[install_dt >= '2022-06-01' & install_dt < '2022-07-01']
payers_june <- payers_june[lifetime >= 0 & lifetime <= 30]

payers_june[, uniqueN(user_pseudo_id)] / installs[dt >= '2022-06-01' & dt < '2022-07-01', uniqueN(user_pseudo_id)]
```

```
## [1] 0.02343383
```

**Алгоритм 2, тоже не очень гибкий**
 - посчитать минимальный лайфтайм пользователей по таблице платежей
 - приджойнить результат к таблице инсталлов
 - посчитать количество пользователей всего и количество пользователей с ненулевым лайфтаймом
 - поделить одно на другое


```r
payers_min <- payments[install_dt >= '2022-06-01' & install_dt < '2022-07-01']
payers_min <- payers_min[lifetime <= 30]
payers_min <- payers_min[, list(min_pay_dt = min(pay_dt)), by = user_pseudo_id]

jun_payers_min <- merge(
  installs[dt >= '2022-06-01' & dt < '2022-07-01'],
  payers_min,
  by = 'user_pseudo_id', all.x = TRUE
)

jun_payers_min_stat <- jun_payers_min[, list(
  total_users = uniqueN(user_pseudo_id), 
  payers = uniqueN(user_pseudo_id[!is.na(min_pay_dt)]))]

jun_payers_min_stat[, payers / total_users]
```

```
## [1] 0.02347897
```

#### задача 3

Посчитайте накопительную конверсию по когорте июньских пользователей.


```r
# ограничиваем датасет по инсталлам
payments_june <- payments[install_dt < '2022-07-01']
payments_june <- payments_june[, list(lifetime = min(lifetime)), by = user_pseudo_id]

# и по лайфтайму
payments_june <- payments_june[lifetime <= 30]
payments_june <- payments_june[lifetime >= 0]

# читаем количество пользователей, сделавших платеж
payments_june_stat <- payments_june[, list(n_payers = uniqueN(user_pseudo_id)), by = lifetime]
setkey(payments_june_stat, lifetime)

# кумулята и значение накопительной конверсии
payments_june_stat[, payers_cum := cumsum(n_payers)]
payments_june_stat[, conversion := payers_cum / installs[dt < '2022-07-01', uniqueN(user_pseudo_id)]]

plot_ly(payments_june_stat, x = ~lifetime, y = ~conversion,
        type = 'scatter', mode = 'lines') %>%
  layout(
    title = 'Накопительная конверсия в платящих',
    xaxis = list(title = ''),
    yaxis = list(title = '', rangemode = 'tozero')) %>%  
  config(displayModeBar = FALSE)
```

```{=html}
<div class="plotly html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-e46f9741d95674e77883" style="width:672px;height:480px;"></div>
<script type="application/json" data-for="htmlwidget-e46f9741d95674e77883">{"x":{"visdat":{"34d3b789e4c3":["function () ","plotlyVisDat"]},"cur_data":"34d3b789e4c3","attrs":{"34d3b789e4c3":{"x":{},"y":{},"mode":"lines","alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"type":"scatter"}},"layout":{"margin":{"b":40,"l":60,"t":25,"r":10},"title":"Накопительная конверсия в платящих","xaxis":{"domain":[0,1],"automargin":true,"title":""},"yaxis":{"domain":[0,1],"automargin":true,"title":"","rangemode":"tozero"},"hovermode":"closest","showlegend":false},"source":"A","config":{"modeBarButtonsToAdd":["hoverclosest","hovercompare"],"showSendToCloud":false,"displayModeBar":false},"data":[{"x":[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30],"y":[0.0072666546307997831,0.011825239212854307,0.014271529156887525,0.016103989889871818,0.017467051814406932,0.018721790936992236,0.019696696154540529,0.020662574471926341,0.021438887885899982,0.022215201299873623,0.022991514713847264,0.023677559126196065,0.024354576638382381,0.025040621050731179,0.02572666546307998,0.026187037371366673,0.026746705181440695,0.027207077089727388,0.027811879400613828,0.028425708611662756,0.02888608051994945,0.029337425528073658,0.029833905037010292,0.03015887344285972,0.030637299151471384,0.031025455858458204,0.03129626286333273,0.031684419570319554,0.032126737678281281,0.032433652283805743,0.032776674489980138],"mode":"lines","type":"scatter","marker":{"color":"rgba(31,119,180,1)","line":{"color":"rgba(31,119,180,1)"}},"error_y":{"color":"rgba(31,119,180,1)"},"error_x":{"color":"rgba(31,119,180,1)"},"line":{"color":"rgba(31,119,180,1)"},"xaxis":"x","yaxis":"y","frame":null}],"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.20000000000000001,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>
```



<br>

<!-- ## ARPU / ARPPU {-} -->
<!-- Averange revenue per user - сумма платежей за определенный период, деленная на общее количество пользователей когорты. Средний чек, наверное, одна из самых важных метрик для оперирования продуктом, так как изучение структуры ARPU позволяет понять, за что платят пользователи и как можно улучшить эту метрику и так далее. -->

<!-- Average revenue per paying user - сумма платежей за определенный период, деленная на количество платящих пользователей когорты. -->

<!-- Обе метрики считаются в определенном окне (количестве дней от инсталла) - обычно 7, 28 или 30 дней. Это необходимо для того, чтобы учесть ситуацию, когда пользователи одной когорты (месячной, например) могли прожить разное количество дней в приложении. Или когда необходимо сравнить разные каналы привлечения, рекламные кампании или группы аб-тестов. -->

<!-- <br> -->

<!-- ## LTV {-} -->
<!-- Lifetime value - общая сумма платежей, которые сделает пользователь за всю свою жизнь в приложении. Так как для каждого пользователя обычно сложно предсказать, сколько он проживет, то считается как кумулятивный средний чек когорты - общая накопленная сумма платежей, сделанная к определенному дню от инсталла, деленная на количество пользователей когорты. Кривая LTV/cumARPU сходится к общему значению ARPU по всей выборке за все время жизни когорты.  -->

<!-- LTV, фактически, одна из ключевых метрик, так как график LTV/cumARPU позволяет оценить динамику платежей когорты, сделать какие-то предсказания. Отношение LTV и CPI позволяют оценить эффективность рекламных кампаний. Например, за 90 дней от инсталла платежами пользователей возвращается 40-60% затраченных на привлечение денег. На 270-360 - все затраченные, и дальнейшие платежи составляют чистую прибыль (абстрактный пример, в реальности периоды сильно зависят от продукта). Соответственно, если даже в перспективе значение LTV когорты (сколько заплатит каждый привлеченный пользователь) не превысит CPI (сколько стоило привлечение каждого пользователя) когорты, то такая рекламная кампания убыточна и может быть полезна только для увеличение объема пользователей. -->

<!-- ### задача 5 {-} -->
<!-- Посчитать кумулятивное ARPU  30  дня по июньской когорте -->

<!-- Алгоритм -->
<!--  - посчитать сумму гросса по дням лайфтайма -->
<!--  - посчитать кумулятивную сумму этого гросса c помощью `cumsum()` -->
<!--  - поделить кумулятивную сумму на общее количество пользователей когорты -->
<!--  - нарисовать график -->

<!-- ```{r} -->
<!-- total_users <- installs[dt >= '2022-06-01' & dt < '2022-07-01', uniqueN(user_pseudo_id)] -->

<!-- payers_june <- payments[install_dt >= '2022-06-01' & install_dt < '2022-07-01'] -->
<!-- payers_june <- payers_june[lifetime >= 0 & lifetime <= 30] -->

<!-- arpu_cum <- payers_june[, list(gross = sum(gross)), by = lifetime] -->
<!-- arpu_cum <- arpu_cum[order(lifetime)] -->
<!-- arpu_cum[, gross_cum := cumsum(gross)] -->

<!-- #нужен мердж, если по платформам или еще каким группам считаем -->
<!-- arpu_cum[, arpu_cum := gross_cum / total_users] -->

<!-- plot_ly(arpu_cum, x = ~lifetime, y = ~arpu_cum, type = 'scatter', mode = 'line') %>% -->
<!--   layout( -->
<!--     # title = 'Выручка в день', -->
<!--     title = 'кумулятивное ARPU', -->
<!--     yaxis = list(rangemode = 'tozero') -->
<!--   ) %>% -->
<!--   config(displayModeBar = FALSE) -->
<!-- ``` -->


## Полезные материалы {-}

[What Is a Business Model? 30 Successful Types of Business Models You Need to Know](https://fourweekmba.com/what-is-a-business-model/) Коротко, что такое бизнес-модели, рассматриваются 30 разных моделей. Полезно для понимания, как вообще могут зарабатывать разные продукты.

[Основные метрики мобильных приложений](https://apptractor.ru/measure/user-analytics/osnovnyie-metriki-mobilnyih-prilozheniy.html) Очень обзорный материал от devtodev. Есть неплохой блок по метрикам монетизации.


## Домашнее задание {-}

Домашние занятия для желающих. Если будут вопросы или необходимость получить от меня какие-то комментарии - пишите в личку в slack.

Задание можете выполнять на любом доступном вам языке / среде для статистики.

### level 1 (IATYTD)

Прочитайте конспект, разберите практические занятия. Обновите знания по работе с табличками --- агрегации (группировки), слияния, создание и модификация колонок.

### level 2 (HNTR)

Постройте график накопительной конверсии с разбивкой по источнику пользователей.

Датасеты: 
- инсталлы: https://gitlab.com/hse_mar/mar211f/-/raw/main/data/installs.csv
- платежи: 'https://gitlab.com/hse_mar/mar211f/-/raw/main/data/payments_custom.csv'


### level 3 (HMP)

Посчитайте по каждой платформе конверсию в платящих в день инсталла. Когорта -- пришедшие в июне.

Делать аналогично динамике ретеншена первого дня.




<br>

### level 4 (UV)

Постройте по платформам накопительную кривую конверсии по дням от инсталла (по аналогии с накопительным ARPU).


```{=html}
<div class="plotly html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-dc9175777985ddf371f9" style="width:672px;height:480px;"></div>
<script type="application/json" data-for="htmlwidget-dc9175777985ddf371f9">{"x":{"visdat":{"34d3b1d0f5622":["function () ","plotlyVisDat"]},"cur_data":"34d3b1d0f5622","attrs":{"34d3b1d0f5622":{"x":{},"y":{},"mode":"lines","color":{},"alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"type":"scatter"}},"layout":{"margin":{"b":40,"l":60,"t":25,"r":10},"title":"Кумулятивная конверсия в платящих","xaxis":{"domain":[0,1],"automargin":true,"title":"день от инсталла"},"yaxis":{"domain":[0,1],"automargin":true,"title":"","rangemode":"tozero"},"hovermode":"closest","showlegend":true},"source":"A","config":{"modeBarButtonsToAdd":["hoverclosest","hovercompare"],"showSendToCloud":false,"displayModeBar":false},"data":[{"x":[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30],"y":[0.0045518837598045522,0.0072907290729072906,0.008602288800308602,0.0095538125241095544,0.010158158673010158,0.01083965539411084,0.0111996913977112,0.011495435257811496,0.011906904976211908,0.012318374694612319,0.012575543268612575,0.012806994985212808,0.013012729844413012,0.013192747846213193,0.013385624276713385,0.013514208563713515,0.01362993442201363,0.013745660280313746,0.013797093995113797,0.0138999614247139,0.013977111996913977,0.014028545711714028,0.014105696283914105,0.014195705284814196,0.014298572714414299,0.014388581715314389,0.014465732287514466,0.014568599717114569,0.014607175003214607,0.01462003343191462,0.014697184004114697],"mode":"lines","type":"scatter","name":"ANDROID","marker":{"color":"rgba(102,194,165,1)","line":{"color":"rgba(102,194,165,1)"}},"textfont":{"color":"rgba(102,194,165,1)"},"error_y":{"color":"rgba(102,194,165,1)"},"error_x":{"color":"rgba(102,194,165,1)"},"line":{"color":"rgba(102,194,165,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30],"y":[0.013783701908512571,0.022175098455013632,0.026385943653438351,0.029142684035140868,0.031172372008482278,0.032808239927294758,0.033959406240533174,0.035292335655861859,0.035928506513177826,0.036655558921538926,0.037564374431990309,0.038079369887912752,0.038442896092093302,0.038897303847318994,0.039291123901847927,0.039594062405331719,0.040109057861254169,0.040411996364737961,0.040805816419266887,0.04119963647379582,0.041532868827627994,0.041926688882156921,0.042259921235989095,0.042502272038776129,0.042744622841563162,0.043108149045743713,0.04322932444713723,0.043380793698879129,0.043623144501666163,0.043895789154801572,0.044016964556195096],"mode":"lines","type":"scatter","name":"IOS","marker":{"color":"rgba(141,160,203,1)","line":{"color":"rgba(141,160,203,1)"}},"textfont":{"color":"rgba(141,160,203,1)"},"error_y":{"color":"rgba(141,160,203,1)"},"error_x":{"color":"rgba(141,160,203,1)"},"line":{"color":"rgba(141,160,203,1)"},"xaxis":"x","yaxis":"y","frame":null}],"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.20000000000000001,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>
```


### level 5 (N)

Посчитайте по каждой платформе конверсию в платящих в день инсталла, суммарно на 3, 7 и 30 дни. Когорта -- пришедшие в июне.

Должна получиться табличка.


```
##    platform total_users day 0 day 3 day 7 day 30
## 1:  ANDROID       77770 0.005 0.010 0.011  0.015
## 2:      IOS       33010 0.014 0.029 0.035  0.044
```

